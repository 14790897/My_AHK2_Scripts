name: Build and Release

on:
  push:
    tags:
      - 'v*'  # è§¦å‘æ¡ä»¶ï¼šæ¨é€ä»¥ v å¼€å¤´çš„æ ‡ç­¾ï¼Œå¦‚ v1.0.0
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download AutoHotkey
        run: |
          $url = "https://www.autohotkey.com/download/2.0/AutoHotkey_2.0.18.zip"
          $output = "AutoHotkey.zip"
          Invoke-WebRequest -Uri $url -OutFile $output
          Expand-Archive -Path $output -DestinationPath "AutoHotkey" -Force
        shell: pwsh
      
      - name: Compile WindowIMEMemory
        run: |
          $ahkPath = Get-ChildItem -Path "AutoHotkey" -Filter "AutoHotkey64.exe" -Recurse | Select-Object -First 1 -ExpandProperty FullName
          $compilerPath = Get-ChildItem -Path "AutoHotkey" -Filter "Ahk2Exe.exe" -Recurse | Select-Object -First 1 -ExpandProperty FullName
          
          if (-not $compilerPath) {
            Write-Error "Compiler not found!"
            exit 1
          }
          
          & $compilerPath /in "WindowIMEMemory.ahk" /out "WindowIMEMemory.exe" /base $ahkPath
          
          if (-not (Test-Path "WindowIMEMemory.exe")) {
            Write-Error "Compilation failed!"
            exit 1
          }
          
          Write-Host "Compilation successful!"
          Get-Item "WindowIMEMemory.exe" | Select-Object Name, Length
        shell: pwsh
      
      - name: Compile AutoLanguage (optional)
        run: |
          $ahkPath = Get-ChildItem -Path "AutoHotkey" -Filter "AutoHotkey64.exe" -Recurse | Select-Object -First 1 -ExpandProperty FullName
          $compilerPath = Get-ChildItem -Path "AutoHotkey" -Filter "Ahk2Exe.exe" -Recurse | Select-Object -First 1 -ExpandProperty FullName
          
          if (Test-Path "AutoLanguage.ahk") {
            & $compilerPath /in "AutoLanguage.ahk" /out "AutoLanguage.exe" /base $ahkPath
            if (Test-Path "AutoLanguage.exe") {
              Write-Host "AutoLanguage compiled successfully!"
            }
          }
        shell: pwsh
        continue-on-error: true
      
      - name: Create source archive
        run: |
          Compress-Archive -Path "*.ahk", "*.md", "license" -DestinationPath "Source-${{ github.ref_name }}.zip" -Force
        shell: pwsh
      
      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ github.ref_name }}
          body: |
            ## ğŸ‰ ${{ github.ref_name }} Release
            
            ### ğŸ“¦ åŒ…å«å†…å®¹
            - WindowIMEMemory.exe - çª—å£è¾“å…¥æ³•è®°å¿†å·¥å…·
            - AutoLanguage.exe - è‡ªåŠ¨åˆ‡æ¢è¾“å…¥æ³•å·¥å…·ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            
            ### ğŸ“ ä½¿ç”¨è¯´æ˜
            
            **WindowIMEMemoryï¼ˆæ¨èï¼‰**ï¼š
            - åŒå‡» `WindowIMEMemory.exe` è¿è¡Œ
            - å³é”®æ‰˜ç›˜å›¾æ ‡å¯ä»¥è®¾ç½®å¼€æœºè‡ªå¯åŠ¨
            - è‡ªåŠ¨è®°å¿†æ¯ä¸ªåº”ç”¨çš„è¾“å…¥æ³•çŠ¶æ€
            
            **AutoLanguage**ï¼š
            - åŸºäºé¢„å®šä¹‰åº”ç”¨åˆ—è¡¨åˆ‡æ¢è¾“å…¥æ³•
            - éœ€è¦æ‰‹åŠ¨é…ç½®åº”ç”¨åˆ—è¡¨
            
            ### ğŸ“– å®Œæ•´æ–‡æ¡£
            è¯·æŸ¥çœ‹ [README.md](https://github.com/${{ github.repository }}/blob/main/README.md)
            
            ### ğŸ”§ ç³»ç»Ÿè¦æ±‚
            - Windows 10/11
            - æ— éœ€å®‰è£… AutoHotkeyï¼ˆç‹¬ç«‹è¿è¡Œï¼‰
          draft: false
          prerelease: false
          files: |
            WindowIMEMemory.exe
            AutoLanguage.exe
            Source-${{ github.ref_name }}.zip
